
import streamlit as st
import pandas as pd

st.set_page_config(page_title="ネイル材料CANVA超えUI", layout="wide")
st.title("🧠 ネイル材料価格表 - CANVA越えアップデート")

columns = ['カテゴリ', '用途', 'ブランド', '製品名', '容量', '通常価格', 'TAT価格', '備考', '優先順位', '容量数値', '容量単位', '単価（通常）', '単価（TAT価格）', '目安使用量', '使用可能回数', '1回あたり材料費']
data = [['ジェル', 'ベースジェル・トップ・アート・長さ出し等', 'Riccagel', 'ベースジェルジュラフィット', '10g', 2750.0, 0.0, 'ネイルパートナーのみ', '1.0', '10.0', 'g', '275.0', '', '0.5', '20.0', '137.5'], ['ジェル', 'ベースジェル・トップ・アート・長さ出し等', 'Riccagel', 'ベースジェルジュラフィット', '30g', 7480.0, 0.0, 'ネイルパートナーのみ', '1.0', '30.0', 'g', '249.33', '', '0.5', '60.0', '124.67'], ['ジェル', 'ベースジェル・トップ・アート・長さ出し等', 'Riccagel', 'ベースジェルジュラフィット', '100g', 19800.0, 0.0, 'ネイルパートナーのみ', '1.0', '100.0', 'g', '198.0', '', '0.5', '200.0', '99.0'], ['ジェル', 'ベースジェル・トップ・アート・長さ出し等', 'Riccagel', 'ベースジェルジュラフィット', '500g', 66000.0, 0.0, '3/1より72000に値上げ', '1.0', '500.0', 'g', '132.0', '', '0.5', '1000.0', '66.0'], ['ジェル', 'ベースジェル・トップ・アート・長さ出し等', 'Riccagel', 'ベースジェルジュラフィット', '500g', 66000.0, 0.0, '3/1より72000に値上げ', '1.0', '500.0', 'g', '132.0', '', '0.5', '1000.0', '66.0'], ['ジェル', 'ベースジェル・トップ・アート・長さ出し等', 'Riccagel', 'RICCAマットコートジェル', '10g', 2750.0, 0.0, '色鉛筆・マットトップ仕上げ用', '1.0', '10.0', 'g', '275.0', '', '0.5', '20.0', '137.5'], ['ジェル', 'ベースジェル・トップ・アート・長さ出し等', 'Riccagel', 'RICCAマットコートジェル', '10g', 2750.0, 0.0, '色鉛筆・マットトップ仕上げ用', '1.0', '10.0', 'g', '275.0', '', '0.5', '20.0', '137.5'], ['ジェル', 'ベースジェル・トップ・アート・長さ出し等', 'Riccagel', 'Riccaノンワイルデコジェル', '8g', 2420.0, 0.0, '多く乗せると少し白くなる', '3.0', '8.0', 'g', '302.5', '', '0.5', '16.0', '151.25'], ['ジェル', 'ベースジェル・トップ・アート・長さ出し等', 'Riccagel', 'Riccaノンワイルデコジェル', '8g', 2420.0, 0.0, '多く乗せると少し白くなる', '3.0', '8.0', 'g', '302.5', '', '0.5', '16.0', '151.25'], ['ジェル', 'ベースジェル・トップ・アート・長さ出し等', 'スネークベース', 'フィルイン用ベースジェル', '5g', 1760.0, 0.0, '楽天／黄色くなりやすい', '3.0', '5.0', 'g', '352.0', '', '0.5', '10.0', '176.0'], ['ジェル', 'ベースジェル・トップ・アート・長さ出し等', 'スネークベース', 'フィルイン用ベースジェル', '15g', 4400.0, 0.0, '楽天／黄色くなりやすい', '3.0', '15.0', 'g', '293.33', '', '0.5', '30.0', '146.67'], ['ジェル', 'ベースジェル・トップ・アート・長さ出し等', 'スネークベース', 'フィルイン用ベースジェル 6個セット', '15g×6', 35200.0, 0.0, '楽天／黄色くなりやすい', '3.0', '15.0', 'g', '391.0', '', '0.5', '30.0', '1173.33'], ['ジェル', 'ベースジェル・トップ・アート・長さ出し等', 'スネークベース', 'フィルイン用ベースジェル 6個セット', '15g×6', 35200.0, 0.0, '楽天／黄色くなりやすい', '3.0', '15.0', 'g', '391.0', '', '0.5', '30.0', '1173.33'], ['ジェル', 'ベースジェル・トップ・アート・長さ出し等', 'メルティジェル', 'クリアジェル', '14g', 1540.0, 1400.0, 'カラー作成用', '1.0', '14.0', 'g', '110.0', '100.0', '0.5', '28.0', '55.0'], ['ジェル', 'ベースジェル・トップ・アート・長さ出し等', 'メルティジェル', 'クリアジェル', '200g', 15400.0, 14000.0, 'カラー作成用', '1.0', '200.0', 'g', '77.0', '70.0', '0.5', '400.0', '38.5'], ['ジェル', 'ベースジェル・トップ・アート・長さ出し等', 'メルティジェル', 'クリアジェル', '200g', 15400.0, 14000.0, 'カラー作成用', '1.0', '200.0', 'g', '77.0', '70.0', '0.5', '400.0', '38.5'], ['ジェル', 'ベースジェル・トップ・アート・長さ出し等', 'TRINA', 'ホイルジェル', '13g', 15400.0, 1800.0, 'TATのみ取扱', '3.0', '13.0', 'g', '77.0', '138.46', '0.5', '26.0', '38.5'], ['ジェル', 'ベースジェル・トップ・アート・長さ出し等', 'TRINA', 'ホイルジェル', '13g', 15400.0, 1800.0, 'TATのみ取扱', '3.0', '13.0', 'g', '77.0', '138.46', '0.5', '26.0', '38.5'], ['ジェル', 'ベースジェル・トップ・アート・長さ出し等', 'プレスト', 'ノーワイプレジンジェル', '8g', 3520.0, 2240.0, 'スムース/リッチ', '2.0', '8.0', 'g', '440.0', '280.0', '0.5', '16.0', '220.0'], ['ジェル', 'ベースジェル・トップ・アート・長さ出し等', 'プレスト', 'ノーワイプレジンジェル', '8g', 3520.0, 2240.0, 'スムース/リッチ', '2.0', '8.0', 'g', '440.0', '280.0', '0.5', '16.0', '220.0'], ['ジェル', 'ベースジェル・トップ・アート・長さ出し等', 'my&bee', 'ノンワイプキャラメルbyYUMA', '10g', 3300.0, 2040.0, 'スムース/リッチ', '2.0', '10.0', 'g', '330.0', '204.0', '0.5', '20.0', '165.0'], ['ジェル', 'ベースジェル・トップ・アート・長さ出し等', 'my&bee', 'ノンワイプキャラメルbyYUMA', '28g', 7428.0, 4500.0, 'スムース/リッチ', '2.0', '28.0', 'g', '265.29', '160.71', '0.5', '56.0', '132.64'], ['ジェル', 'ベースジェル・トップ・アート・長さ出し等', 'my&bee', 'ノンワイプキャラメルbyYUMA', '28g', 7428.0, 4500.0, 'スムース/リッチ', '2.0', '28.0', 'g', '265.29', '160.71', '0.5', '56.0', '132.64'], ['ジェル', 'ベースジェル・トップ・アート・長さ出し等', 'ibd', 'LEDクリアジェル', '14g', 3124.0, 2840.0, 'ハードジェル', '2.0', '14.0', 'g', '223.14', '202.86', '0.5', '28.0', '111.57'], ['ジェル', 'ベースジェル・トップ・アート・長さ出し等', 'ibd', 'LEDクリアジェル', '56g', 8250.0, 7500.0, 'ハードジェル', '2.0', '56.0', 'g', '147.32', '133.93', '0.5', '112.0', '73.66'], ['ジェル', 'ベースジェル・トップ・アート・長さ出し等', 'ibd', 'LEDクリアジェル', '226g', 21120.0, 19200.0, 'ハードジェル', '2.0', '226.0', 'g', '93.45', '84.96', '0.5', '452.0', '46.73'], ['ジェル', 'ベースジェル・トップ・アート・長さ出し等', 'ibd', 'LEDクリアジェル', '226g', 21120.0, 19200.0, 'ハードジェル', '2.0', '226.0', 'g', '93.45', '84.96', '0.5', '452.0', '46.73'], ['トップコート', '仕上げの艶出し・ミラーネイル仕上げ', 'クリストリオ', 'ベーシックワンクリアジェル', '14.84g', 2772.0, 2520.0, 'ハードジェル', '1.0', '226.0', 'g', '93.45', '84.96', '0.5', '452.0', '46.73'], ['トップコート', '仕上げの艶出し・ミラーネイル仕上げ', 'クリストリオ', 'ベーシックワンクリアジェル', '29.6g', 4290.0, 3900.0, 'ハードジェル', '1.0', '226.0', 'g', '93.45', '84.96', '0.5', '452.0', '46.73'], ['トップコート', '仕上げの艶出し・ミラーネイル仕上げ', 'クリストリオ', 'ベーシックワンクリアジェル', '236g', 19602.0, 17820.0, 'ハードジェル', '1.0', '236.0', 'g', '83.06', '75.51', '0.5', '472.0', '41.53'], ['トップコート', '仕上げの艶出し・ミラーネイル仕上げ', 'クリストリオ', 'ベーシックワンクリアジェル', '236g', 19602.0, 17820.0, 'ハードジェル', '1.0', '236.0', 'g', '83.06', '75.51', '0.5', '472.0', '41.53'], ['トップコート', '仕上げの艶出し・ミラーネイル仕上げ', 'PREGEL', 'ノンワイプクリアキャンジェル', '8g', 1510.0, 17820.0, 'ノンヒート', '1.0', '8.0', 'g', '188.75', '75.51', '0.5', '16.0', '94.38'], ['トップコート', '仕上げの艶出し・ミラーネイル仕上げ', 'PREGEL', 'ノンワイプクリアキャンジェル', '14g', 2178.0, 17820.0, 'ノンヒート', '1.0', '14.0', 'g', '155.57', '75.51', '0.5', '28.0', '77.79'], ['トップコート', '仕上げの艶出し・ミラーネイル仕上げ', 'PREGEL', 'ノンワイプクリアキャンジェル', '14g', 2178.0, 17820.0, 'ノンヒート', '1.0', '14.0', 'g', '155.57', '75.51', '0.5', '28.0', '77.79'], ['トップコート', '仕上げの艶出し・ミラーネイル仕上げ', 'STORY365', 'ノンワイプトップジェル', '14g', 2178.0, 1800.0, 'パウダー付きにくいミラー用', '1.0', '14.0', 'g', '155.57', '75.51', '0.5', '28.0', '77.79'], ['トップコート', '仕上げの艶出し・ミラーネイル仕上げ', 'STORY365', 'ノンワイプトップジェル', '14g', 2178.0, 1800.0, 'パウダー付きにくいミラー用', '1.0', '14.0', 'g', '155.57', '75.51', '0.5', '28.0', '77.79'], ['トップコート', '仕上げの艶出し・ミラーネイル仕上げ', "toy's×inity", 'ノンワイプマットコート', '14g', 2805.0, 1700.0, 'ミラー付きにくいデザイン用', '1.0', '14.0', 'g', '155.57', '75.51', '0.5', '28.0', '77.79'], ['トップコート', '仕上げの艶出し・ミラーネイル仕上げ', "toy's×inity", 'ノンワイプマットコート', '14g', 2805.0, 1700.0, 'ミラー付きにくいデザイン用', '1.0', '14.0', 'g', '155.57', '75.51', '0.5', '28.0', '77.79'], ['プライマー', 'ジェル前の油分除去・密着力向上', 'PREGEL', 'マジカルプライマー（ぞうさん）', '7ml', 990.0, 900.0, 'ミラー付きにくいデザイン用', '3.0', '7.0', 'ml', '141.43', '128.57', '0.1', '70.0', '14.14'], ['プライマー', 'ジェル前の油分除去・密着力向上', 'PREGEL', 'マジカルプライマー（ぞうさん）', '7ml', 990.0, 900.0, 'ミラー付きにくいデザイン用', '3.0', '7.0', 'ml', '141.43', '128.57', '0.1', '70.0', '14.14'], ['プライマー', 'ジェル前の油分除去・密着力向上', 'フルーリア', 'プレプライマー', '10ml', 1540.0, 900.0, 'ミラー付きにくいデザイン用', '3.0', '10.0', 'ml', '154.0', '128.57', '0.1', '100.0', '15.4'], ['プライマー', 'ジェル前の油分除去・密着力向上', 'フルーリア', 'プレプライマー', '10ml', 1540.0, 900.0, 'ミラー付きにくいデザイン用', '3.0', '10.0', 'ml', '154.0', '128.57', '0.1', '100.0', '15.4'], ['プライマー', 'ジェル前の油分除去・密着力向上', 'ネイルデダンス', 'ノンアシッドプライマー', '10ml', 2288.0, 2080.0, 'ミラー付きにくいデザイン用', '3.0', '10.0', 'ml', '228.8', '208.0', '0.1', '100.0', '22.88'], ['プライマー', 'ジェル前の油分除去・密着力向上', 'ネイルデダンス', 'ノンアシッドプライマー', '10ml', 2288.0, 2080.0, 'ミラー付きにくいデザイン用', '3.0', '10.0', 'ml', '228.8', '208.0', '0.1', '100.0', '22.88'], ['プライマー', 'ジェル前の油分除去・密着力向上', 'ハーモニー', 'プロボンド', '10ml', 2288.0, 1680.0, 'ミラー付きにくいデザイン用', '1.0', '10.0', 'ml', '228.8', '208.0', '0.1', '100.0', '22.88'], ['プライマー', 'ジェル前の油分除去・密着力向上', 'ハーモニー', 'プロボンド', '10ml', 2288.0, 1680.0, 'ミラー付きにくいデザイン用', '1.0', '10.0', 'ml', '228.8', '208.0', '0.1', '100.0', '22.88'], ['アクリル', 'スカルプ・補強・アクリルネイル用', 'フルーリア', 'フルーリアパウダークリア', '25g', 1793.0, 1680.0, 'ミラー付きにくいデザイン用', '2.0', '25.0', 'g', '71.72', '208.0', '0.5', '50.0', '35.86'], ['アクリル', 'スカルプ・補強・アクリルネイル用', 'フルーリア', 'フルーリアパウダークリア', '80g', 3872.0, 1680.0, 'ミラー付きにくいデザイン用', '2.0', '80.0', 'g', '48.4', '208.0', '0.5', '160.0', '24.2'], ['アクリル', 'スカルプ・補強・アクリルネイル用', 'フルーリア', 'フルーリアパウダークリア', '80g', 3872.0, 1680.0, 'ミラー付きにくいデザイン用', '2.0', '80.0', 'g', '48.4', '208.0', '0.5', '160.0', '24.2'], ['アクリル', 'スカルプ・補強・アクリルネイル用', 'フルーリア', 'アクリルリキッド', '50ml', 1650.0, 1680.0, 'ミラー付きにくいデザイン用', '2.0', '50.0', 'ml', '33.0', '208.0', '0.5', '100.0', '16.5'], ['アクリル', 'スカルプ・補強・アクリルネイル用', 'フルーリア', 'アクリルリキッド', '120ml', 3432.0, 1680.0, 'ミラー付きにくいデザイン用', '2.0', '120.0', 'ml', '28.6', '208.0', '0.5', '240.0', '14.3'], ['アクリル', 'スカルプ・補強・アクリルネイル用', 'フルーリア', 'アクリルリキッド', '480ml', 8250.0, 1680.0, 'ミラー付きにくいデザイン用', '2.0', '480.0', 'ml', '17.19', '208.0', '0.5', '960.0', '8.59'], ['アクリル', 'スカルプ・補強・アクリルネイル用', 'フルーリア', 'アクリルリキッド', '480ml', 8250.0, 1680.0, 'ミラー付きにくいデザイン用', '2.0', '480.0', 'ml', '17.19', '208.0', '0.5', '960.0', '8.59'], ['アクセ', 'ネイルアート・接着補助', 'MITHOS', 'アクティベーター', '20ml', 8250.0, 980.0, 'ミラー付きにくいデザイン用', '1.0', '20.0', 'ml', '17.19', '49.0', '0.2', '100.0', '8.59'], ['アクセ', 'ネイルアート・接着補助', 'MITHOS', 'アクティベーター', '100ml', 8250.0, 2900.0, 'ミラー付きにくいデザイン用', '1.0', '100.0', 'ml', '17.19', '29.0', '0.2', '500.0', '8.59'], ['アクセ', 'ネイルアート・接着補助', 'MITHOS', 'アクティベーター', '100ml', 8250.0, 2900.0, 'ミラー付きにくいデザイン用', '1.0', '100.0', 'ml', '17.19', '29.0', '0.2', '500.0', '8.59'], ['アクセ', 'ネイルアート・接着補助', 'MITHOS', 'ibdビルダーレジン+アクティベーター', '6g+20ml', 8250.0, 1680.0, 'ミラー付きにくいデザイン用', '2.0', '6.0', 'g', '17.19', '280.0', '0.2', '30.0', '8.59'], ['アクセ', 'ネイルアート・接着補助', 'MITHOS', 'ibdビルダーレジン+アクティベーター', '6g+20ml', 8250.0, 1680.0, 'ミラー付きにくいデザイン用', '2.0', '6.0', 'g', '17.19', '280.0', '0.2', '30.0', '8.59'], ['チップ', '長さ出し・チップ装着用', 'ミトス', 'ハーフチップ120P', '6g+20ml', 1510.0, 720.0, 'スカルプ練習用', '3.0', '6.0', 'g', '17.19', '280.0', '1.0', '30.0', '8.59'], ['チップ', '長さ出し・チップ装着用', 'ミトス', 'サイズ別チップ', '6g+20ml', 566.0, 360.0, 'スカルプ練習用', '3.0', '6.0', 'g', '17.19', '280.0', '1.0', '30.0', '8.59'], ['チップ', '長さ出し・チップ装着用', 'SHAREYDVA', 'スタンダードチップナチュラルアソート120P', '6g+20ml', 1210.0, 720.0, 'スカルプ練習用', '3.0', '6.0', 'g', '17.19', '280.0', '1.0', '30.0', '8.59'], ['チップ', '長さ出し・チップ装着用', 'SHAREYDVA', 'ナチュラルコンタクトゾーン付き', '6g+20ml', 1210.0, 720.0, 'スカルプ練習用', '3.0', '6.0', 'g', '17.19', '280.0', '1.0', '30.0', '8.59'], ['チップ', '長さ出し・チップ装着用', 'SHAREYDVA', 'チップディプレッション', '6g+20ml', 1210.0, 770.0, 'コンタクトゾーン付き', '3.0', '6.0', 'g', '17.19', '280.0', '1.0', '30.0', '8.59'], ['チップ', '長さ出し・チップ装着用', 'SHAREYDVA', 'チップディプレッション', '6g+20ml', 1210.0, 770.0, 'コンタクトゾーン付き', '3.0', '6.0', 'g', '17.19', '280.0', '1.0', '30.0', '8.59'], ['溶剤', 'ジェルオフ用アセトン', 'スペースネイル', 'アセトン', '130ml', 550.0, 500.0, 'コンタクトゾーン付き', '1.0', '130.0', 'ml', '4.23', '3.85', '15.0', '8.0', '68.75'], ['溶剤', 'ジェルオフ用アセトン', 'スペースネイル', 'アセトン', '500ml', 1210.0, 1100.0, 'コンタクトゾーン付き', '1.0', '500.0', 'ml', '2.42', '2.2', '15.0', '33.0', '36.67'], ['溶剤', 'ジェルオフ用アセトン', 'スペースネイル', 'アセトン', '1200ml', 1980.0, 1800.0, 'コンタクトゾーン付き', '1.0', '1200.0', 'ml', '1.65', '1.5', '15.0', '80.0', '24.75'], ['溶剤', 'ジェルオフ用アセトン', 'スペースネイル', 'アセトン', '1200ml', 1980.0, 1800.0, 'コンタクトゾーン付き', '1.0', '1200.0', 'ml', '1.65', '1.5', '15.0', '80.0', '24.75'], ['グルー', 'チップやパーツの接着用', 'NFS', 'ブラッシュオングルー', '6g', 550.0, 350.0, 'コンタクトゾーン付き', '1.0', '6.0', 'g', '91.67', '58.33', '0.2', '30.0', '18.33'], ['グルー', 'チップやパーツの接着用', 'erikonail', 'ネイルグルー', '8g', 495.0, 315.0, 'コンタクトゾーン付き', '1.0', '8.0', 'g', '61.88', '39.38', '0.2', '40.0', '12.38'], ['グルー', 'チップやパーツの接着用', 'erikonail', 'ネイルグルー', '8g', 495.0, 315.0, 'コンタクトゾーン付き', '1.0', '8.0', 'g', '61.88', '39.38', '0.2', '40.0', '12.38'], ['消耗品', 'サンディング等ネイルケア用', 'ネイルラボ', 'サンディングバンド25個', '8g', 1232.0, 315.0, 'コンタクトゾーン付き', '1.0', '8.0', 'g', '61.88', '39.38', '1.0', '40.0', '12.38'], ['消耗品', 'サンディング等ネイルケア用', 'ネイルラボ', 'サンディングバンド25個', '8g', 1232.0, 315.0, 'コンタクトゾーン付き', '1.0', '8.0', 'g', '61.88', '39.38', '1.0', '40.0', '12.38'], ['ライト', 'ジェル硬化用LED/UVライト', 'Riccagel', 'ハイブリッドLEDライトⅡ', '8g', 25600.0, 315.0, 'ネイルパートナーのみ', '1.0', '8.0', 'g', '61.88', '39.38', '1.0', '40.0', '12.38'], ['ライト', 'ジェル硬化用LED/UVライト', 'clou', 'LED&UVライト', '8g', 9350.0, 315.0, 'ネイルパートナーのみ', '3.0', '8.0', 'g', '61.88', '39.38', '1.0', '40.0', '12.38'], ['ライト', 'ジェル硬化用LED/UVライト', 'clou', 'コードレスライト', '8g', 13200.0, 315.0, 'ネイルパートナーのみ', '3.0', '8.0', 'g', '61.88', '39.38', '1.0', '40.0', '12.38'], ['ライト', 'ジェル硬化用LED/UVライト', 'LxiaPerfelt', '36Wライト', '8g', 20900.0, 315.0, 'ネイルパートナーのみ', '3.0', '8.0', 'g', '61.88', '39.38', '1.0', '40.0', '12.38'], ['ライト', 'ジェル硬化用LED/UVライト', 'SHINYGEL', 'クレッシェンドハイブリッドLED', '8g', 28413.0, 315.0, 'コードレスN 36W', '3.0', '8.0', 'g', '61.88', '39.38', '1.0', '40.0', '12.38'], ['ライト', 'ジェル硬化用LED/UVライト', 'KOKOIST', 'コードレスライト', '8g', 39600.0, 315.0, 'コードレスN 36W', '3.0', '8.0', 'g', '61.88', '39.38', '1.0', '40.0', '12.38'], ['ライト', 'ジェル硬化用LED/UVライト', 'SHINYGEL', '6Wライト', '8g', 3850.0, 315.0, 'コードレスN 36W', '3.0', '8.0', 'g', '61.88', '39.38', '1.0', '40.0', '12.38'], ['ライト', 'ジェル硬化用LED/UVライト', 'SHINYGEL', 'ポータブルハイブリッド', '8g', 4400.0, 315.0, 'コードレスN 36W', '3.0', '8.0', 'g', '61.88', '39.38', '1.0', '40.0', '12.38']]
df = pd.DataFrame(data, columns=columns)

for col in ["通常価格", "TAT価格", "単価（通常）", "単価（TAT価格）", "使用可能回数", "1回あたり材料費"]:
    df[col] = pd.to_numeric(df[col], errors="coerce").fillna(0)

if "selected" not in st.session_state:
    st.session_state.selected = []
if "checked_ids" not in st.session_state:
    st.session_state.checked_ids = set()

with st.sidebar:
    st.header("🔎 絞り込み")
    keyword = st.text_input("キーワード検索（商品名・ブランド・用途）")
    min_price = st.number_input("最低単価（通常）", 0, 10000, 0)
    max_price = st.number_input("最高単価（通常）", 0, 10000, 10000)
    min_uses = st.number_input("最低使用可能回数", 0, 10000, 0)
    reset = st.button("🧹 チェックリセット")
    if reset:
        st.session_state.selected = []
        st.session_state.checked_ids = set()

filtered = df.drop_duplicates(subset=['ブランド', '製品名']).copy()
if keyword:
    keyword = keyword.lower()
    filtered = filtered[
        filtered["製品名"].str.lower().str.contains(keyword) |
        filtered["ブランド"].str.lower().str.contains(keyword) |
        filtered["用途"].str.lower().str.contains(keyword)
    ]
filtered = filtered[
    (filtered["単価（通常）"] >= min_price) &
    (filtered["単価（通常）"] <= max_price) &
    (filtered["使用可能回数"] >= min_uses)
]

st.markdown(f"### 📦 条件に合致：{len(filtered)} 件")

for idx, row in filtered.iterrows():
    cid = f"chk_{row['ブランド']}_{row['製品名']}_{idx}"
    with st.container():
        cols = st.columns([0.05, 0.95])
        with cols[0]:
            checked = cid in st.session_state.checked_ids
            if st.checkbox("", key=cid, value=checked):
                if cid not in st.session_state.checked_ids:
                    st.session_state.checked_ids.add(cid)
                    st.session_state.selected.append(row)
            else:
                if cid in st.session_state.checked_ids:
                    st.session_state.checked_ids.remove(cid)
                    st.session_state.selected = [
                        r for r in st.session_state.selected if not (
                            r["ブランド"] == row["ブランド"] and r["製品名"] == row["製品名"])
                    ]
        with cols[1]:
            comment = ""
            if row["容量数値"] and row["単価（通常）"]:
                g = float(row["容量数値"])
                p = float(row["単価（通常）"])
                if g >= 100 and p <= 200:
                    comment = "🟢 コスパ良・大容量おすすめ"
                elif g < 10 and p > 300:
                    comment = "🔴 小容量高単価 → 見直し検討"
            st.markdown(f"""
**{row['製品名']}** ({row['容量']})
- ブランド：{row['ブランド']} ／ 用途：{row['用途']}
- 単価（通常）：¥{int(row['単価（通常）'])} ／ TAT：¥{int(row['単価（TAT価格）']) if row['単価（TAT価格）'] else 0}
- 使用可能回数：約 {int(row['使用可能回数'])} 回 ／ 材料費：¥{int(row['1回あたり材料費'])}
<span style='color:gray;font-size:12px'>{row['備考']}</span>  
<span style='color:#009900;font-weight:bold'>{comment}</span>
""", unsafe_allow_html=True)
    st.markdown("---")
# 💰 リアルタイム合計金額表示（サイドバー内）
if st.session_state.selected:
    realtime_df = pd.DataFrame(st.session_state.selected)
    reg = int(realtime_df["通常価格"].sum())
    tat = int(realtime_df["TAT価格"].sum())
    avg = int(realtime_df["1回あたり材料費"].mean())
        st.sidebar.markdown(f"### 💰 合計")
    st.sidebar.success(f"通常: ¥{reg:,}\nTAT: ¥{tat:,}\n平均: ¥{avg}")


if st.session_state.selected:
    result_df = pd.DataFrame(st.session_state.selected)
    total_regular = result_df["通常価格"].sum()
    total_tat = result_df["TAT価格"].sum()
    avg_cost = result_df["1回あたり材料費"].mean()
    st.success(f"💰 合計：通常 ¥{int(total_regular):,} ／ TAT ¥{int(total_tat):,} ／ 平均 材料費 ¥{int(avg_cost):,}")
    with st.expander("📋 選択一覧", expanded=False):
        st.dataframe(result_df.reset_index(drop=True), use_container_width=True)
else:
    st.info("☝ 商品をチェックすると結果が表示されます。")
